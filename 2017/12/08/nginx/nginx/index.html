<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>nginx 配置 | 你总是这样轻言放弃的话，无论多久你都只会原地踏步。</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">nginx 配置</h1><a id="logo" href="/.">你总是这样轻言放弃的话，无论多久你都只会原地踏步。</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">nginx 配置</h1><div class="post-meta">Dec 8, 2017<span> | </span><span class="category"><a href="/categories/linux/">linux</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2017/12/08/nginx/nginx/" href="/2017/12/08/nginx/nginx/#comments" class="ds-thread-count"></a><div class="post-content"><h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>MAC<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install nginx-full --with-status --with-lua-module --with-redis2-module --with-redis2-module</span><br><span class="line">brew install openresty</span><br></pre></td></tr></table></figure></p>
<p>Linux 【增加lua扩展】<br>(<a href="https://github.com/openresty/lua-nginx-module#installation)[https://github.com/openresty/lua-nginx-module#installation]" target="_blank" rel="noopener">https://github.com/openresty/lua-nginx-module#installation)[https://github.com/openresty/lua-nginx-module#installation]</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum install nginx-full</span><br><span class="line">下载 ngx_devel_kit ngx_lua 源码</span><br><span class="line">记录 nginx -V 的配置</span><br><span class="line">--prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt=&apos;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC&apos; --with-ld-opt=&apos;-Wl,-z,relro -Wl,-z,now -pie&apos; \</span><br><span class="line">--add-module=/_html/tools/nginx/ngx_devel_kit-0.3.0 \</span><br><span class="line">--add-module=/_html/tools/nginx/lua-nginx-module-0.10.9rc7</span><br><span class="line">make </span><br><span class="line">mv /usr/sbin/nginx /usr/sbin/nginx.bak</span><br><span class="line">ln -s /_html/tools/nginx/objs/nginx /usr/sbin/nginx</span><br><span class="line">nginx -s stop</span><br><span class="line">nginx</span><br></pre></td></tr></table></figure></p>
<h3 id="Nginx-调优"><a href="#Nginx-调优" class="headerlink" title="Nginx 调优"></a>Nginx 调优</h3><p>先查看一下机器的cpu合数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/cpuinfo | grep processor</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>worker_processes<br>设置为cpu核数</p>
</li>
<li><p>events</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">     # 语法  use [ kqueue | rtsig | epoll | /dev/poll | select | poll ];</span><br><span class="line">     use epoll;                         # 使用epoll（linux2.6的高性能方式）</span><br><span class="line">     worker_connections 51200;          #每个进程最大连接数（最大连接=连接数×进程数）</span><br><span class="line"></span><br><span class="line">     # 并发总数是 worker_processes 和 worker_connections 的乘积</span><br><span class="line">     # 即 max_clients = worker_processes * worker_connections</span><br><span class="line">     # 在设置了反向代理的情况下，max_clients = worker_processes * worker_connections / 4</span><br><span class="line">     # 并发受IO约束，max_clients的值须小于系统可以打开的最大文件数</span><br><span class="line">     # 查看系统可以打开的最大文件数</span><br><span class="line">     # cat /proc/sys/fs/file-max</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Nginx-rewrite"><a href="#Nginx-rewrite" class="headerlink" title="Nginx rewrite"></a>Nginx rewrite</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ~* ^/weixin/ &#123;</span><br><span class="line">    rewrite &quot;^/weixin/(.*)$&quot; http://weixin.phalcon.app/$1 last;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Nginx-代理"><a href="#Nginx-代理" class="headerlink" title="Nginx 代理"></a>Nginx 代理</h3><p>当出现/phalcon/时进行代理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /phalcon/ &#123;</span><br><span class="line">    proxy_pass http://phalcon.phalcon.app/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有的都代理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  phalcon.app;</span><br><span class="line">    location / &#123; </span><br><span class="line">        proxy_pass          http://s.phalcon.app;</span><br><span class="line">        proxy_set_header    Host                $host:$server_port;</span><br><span class="line">        proxy_set_header    X-Real-IP           $remote_addr;</span><br><span class="line">        proxy_set_header    X-Real-PORT         $remote_port;</span><br><span class="line">        proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Nginx-负载均衡"><a href="#Nginx-负载均衡" class="headerlink" title="Nginx 负载均衡"></a>Nginx 负载均衡</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">upstream upstream_nginx &#123;</span><br><span class="line">    #ip_hash;   #ip_hash来处理session</span><br><span class="line">    server  127.0.0.1:8080 weight=10;</span><br><span class="line">    server  127.0.0.1:8081 weight=10;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  s.nginx.app;</span><br><span class="line">    location / &#123; </span><br><span class="line">        proxy_pass          http://upstream_nginx;</span><br><span class="line">        proxy_set_header    Host                $host:$server_port;</span><br><span class="line">        proxy_set_header    X-Real-IP           $remote_addr;</span><br><span class="line">        proxy_set_header    X-Real-PORT         $remote_port;</span><br><span class="line">        proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">     listen       8080;</span><br><span class="line">     server_name  s.nginx.app;</span><br><span class="line">     ...</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">server &#123;</span><br><span class="line">    listen       8081;</span><br><span class="line">    server_name  s.nginx.app;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Nginx-Lua-执行顺序"><a href="#Nginx-Lua-执行顺序" class="headerlink" title="Nginx Lua 执行顺序"></a>Nginx Lua 执行顺序</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">init_by_lua            http</span><br><span class="line">set_by_lua             server, server if, location, location if</span><br><span class="line">rewrite_by_lua         http, server, location, location if</span><br><span class="line">access_by_lua          http, server, location, location if</span><br><span class="line">content_by_lua         location, location if</span><br><span class="line">header_filter_by_lua   http, server, location, location if</span><br><span class="line">body_filter_by_lua     http, server, location, location if</span><br><span class="line">log_by_lua             http, server, location, location if</span><br><span class="line">timer</span><br></pre></td></tr></table></figure>
<h3 id="Nginx-Lua-注释"><a href="#Nginx-Lua-注释" class="headerlink" title="Nginx Lua 注释"></a>Nginx Lua 注释</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">init_by_lua:</span><br><span class="line">在nginx重新加载配置文件时，运行里面lua脚本，常用于全局变量的申请。</span><br><span class="line">例如lua_shared_dict共享内存的申请，只有当nginx重起后，共享内存数据才清空，这常用于统计。</span><br><span class="line"></span><br><span class="line">set_by_lua:</span><br><span class="line">设置一个变量，常用与计算一个逻辑，然后返回结果</span><br><span class="line">该阶段不能运行Output API、Control API、Subrequest API、Cosocket API</span><br><span class="line"></span><br><span class="line">rewrite_by_lua:</span><br><span class="line">在access阶段前运行，主要用于rewrite</span><br><span class="line"></span><br><span class="line">access_by_lua:</span><br><span class="line">主要用于访问控制，能收集到大部分变量，类似status需要在log阶段才有。</span><br><span class="line">这条指令运行于nginx access阶段的末尾，因此总是在 allow 和 deny 这样的指令之后运行，虽然它们同属 access 阶段。</span><br><span class="line"></span><br><span class="line">content_by_lua:</span><br><span class="line">阶段是所有请求处理阶段中最为重要的一个，运行在这个阶段的配置指令一般都肩负着生成内容（content）并输出HTTP响应。</span><br><span class="line"></span><br><span class="line">header_filter_by_lua:</span><br><span class="line">一般只用于设置Cookie和Headers等</span><br><span class="line">该阶段不能运行Output API、Control API、Subrequest API、Cosocket API</span><br><span class="line"></span><br><span class="line">body_filter_by_lua:</span><br><span class="line">一般会在一次请求中被调用多次, 因为这是实现基于 HTTP 1.1 chunked 编码的所谓“流式输出”的。</span><br><span class="line">该阶段不能运行Output API、Control API、Subrequest API、Cosocket API</span><br><span class="line"></span><br><span class="line">log_by_lua:</span><br><span class="line">该阶段总是运行在请求结束的时候，用于请求的后续操作，如在共享内存中进行统计数据,如果要高精确的数据统计，应该使用body_filter_by_lua。</span><br><span class="line">该阶段不能运行Output API、Control API、Subrequest API、Cosocket API</span><br><span class="line"></span><br><span class="line">timer:</span><br></pre></td></tr></table></figure>
<h3 id="Location"><a href="#Location" class="headerlink" title="Location"></a>Location</h3><ul>
<li>匹配规则</li>
</ul>
<ol>
<li>普通、正则先　普通location 再匹配正则location。如果正则location存在则命中正则location，否则命中普通location。</li>
<li>普通location 命中长度长的location。</li>
</ol>
<ul>
<li>匹配前缀<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~ 大小写敏感　正则匹配 </span><br><span class="line">~* 大小写不敏感　正则匹配 </span><br><span class="line">!~ 大小写敏感　正则不匹配 </span><br><span class="line">!~* 大小写不敏感　正则不匹配</span><br><span class="line"></span><br><span class="line">＝ 前缀与uri完全相同　普通匹配</span><br><span class="line">^~ 不进行正则匹配　普通匹配</span><br><span class="line">不填 前缀匹配　普通匹配</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="PATH-INFO"><a href="#PATH-INFO" class="headerlink" title="PATH_INFO"></a>PATH_INFO</h3><p>(<a href="http://www.nginx.cn/426.html)[http://www.nginx.cn/426.html]" target="_blank" rel="noopener">http://www.nginx.cn/426.html)[http://www.nginx.cn/426.html]</a></p>
<h3 id="TCP负载均衡"><a href="#TCP负载均衡" class="headerlink" title="TCP负载均衡"></a>TCP负载均衡</h3><ol>
<li><p>首先编译Nginx stream模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MAC:</span><br><span class="line">brew reinstall nginx-full --with-stream</span><br><span class="line"></span><br><span class="line">Linux:</span><br><span class="line"># yum源默认自带</span><br><span class="line">yum install nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改nginx.conf</p>
</li>
</ol>
<p>低版本Nginx可能不支持stream下log_format</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 增加以下 具体配置放到同级streams下</span><br><span class="line">error_log  /Users/limx/Applications/runtime/nginx/error.log;</span><br><span class="line"></span><br><span class="line">stream &#123;</span><br><span class="line">    log_format log_format_stream &apos;$remote_addr [$time_local] &apos;</span><br><span class="line">                 &apos;$protocol $status $bytes_sent $bytes_received &apos;</span><br><span class="line">                 &apos;$session_time &quot;$upstream_addr&quot; &apos;</span><br><span class="line">                 &apos;&quot;$upstream_bytes_sent&quot; &quot;$upstream_bytes_received&quot; &quot;$upstream_connect_time&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    access_log /Users/limx/Applications/runtime/nginx/tcp-access.log log_format_stream;</span><br><span class="line">    include streams/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>编写配置 streams/demo.conf</li>
</ol>
<ul>
<li>max_conns=5 最大连接数</li>
<li>fail_timeout=30 在这个时间段中进行了多少次连接的尝试失败了，那么就认为是不可达了并标记不可达</li>
<li>max_fails=5 和上面是对应上的尝试失败次数。</li>
<li>backup 标记server为备用server</li>
<li>done 标记server不可用</li>
<li>slow_start=30 当server从不健康变成健康服务时，权重由0变为标准值的时间</li>
<li>zone [name] [size] 定义共享内存区域的名称和大小，该组存储组的配置和运行时状态是在进程之间共享的。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream tcp_upstream_default &#123;</span><br><span class="line">    zone upstream_dynamic 64k;</span><br><span class="line">    server  127.0.0.1:12001 weight=10;</span><br><span class="line">    server  127.0.0.1:12002 weight=5 fail_timeout=30 max_fails=5;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen                      12000;</span><br><span class="line">    proxy_connect_timeout       5s;</span><br><span class="line">    proxy_timeout               30s;</span><br><span class="line">    proxy_pass                  tcp_upstream_default;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="编译Rtmp扩展"><a href="#编译Rtmp扩展" class="headerlink" title="编译Rtmp扩展"></a>编译Rtmp扩展</h3><p>MAC<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install nginx-full --with-status --with-stream --with-rtmp-module</span><br></pre></td></tr></table></figure></p>
<p>Linux</p>
<ul>
<li><p>确定Nginx版本 我这里是v1.12.2 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nginx -v</span><br></pre></td></tr></table></figure>
</li>
<li><p>确定已编译的扩展</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ nginx -V </span><br><span class="line">结果如下：</span><br><span class="line">--prefix=/etc/nginx --sbin-path=/usr/local/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt=&apos;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC&apos; --with-ld-opt=&apos;-Wl,-z,relro -Wl,-z,now -pie&apos;</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载最新扩展 和 Nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/arut/nginx-rtmp-module/archive/v1.2.0.zip</span><br><span class="line">$ wget http://nginx.org/download/nginx-1.12.2.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译</p>
</li>
</ul>
<p>进入nginx-1.12.2目录编译Nginx 参数为之前nginx -V 显示的参数 在最后增加 –add-module=/_html/tools/nginx/nginx-rtmp-module-1.2.0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./configure --prefix=/etc/nginx --sbin-path=/usr/local/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt=&apos;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC&apos; --with-ld-opt=&apos;-Wl,-z,relro -Wl,-z,now -pie&apos; --add-module=/_html/tools/nginx/nginx-rtmp-module-1.2.0</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure>
<ul>
<li><p>建立软连接 /_html/tools/nginx/nginx-1.12.2/objs/nginx 为编译好的脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd /usr/local/sbin</span><br><span class="line">$ ln -s /_html/tools/nginx/nginx-1.12.2/objs/nginx nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启终端测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ nginx -V</span><br><span class="line">$ nginx -t</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 nginx.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rtmp &#123;</span><br><span class="line">    include rtmp/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置demo.conf<br>vim rtmp/demo.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 13001;</span><br><span class="line">    chunk_size 4096;</span><br><span class="line">    </span><br><span class="line">    application rtmp &#123;</span><br><span class="line">        live on;</span><br><span class="line">        # record keyframes;</span><br><span class="line">        # record_path /tmp;</span><br><span class="line">        # record_max_size 128k;</span><br><span class="line">        # record_interval 30s;</span><br><span class="line">        # record_suffix .this.is.flv;</span><br><span class="line">        </span><br><span class="line">        # on_publish http://localhost:8080/publish;</span><br><span class="line">        # on_play http://localhost:8080/play;</span><br><span class="line">        # on_record_done http://localhost:8080/record_donw;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    application hls &#123;</span><br><span class="line">        live on;</span><br><span class="line">        hls on;</span><br><span class="line">        hls_path /Users/limx/Applications/runtime/rtmp/hls;</span><br><span class="line">        hls_fragment 10s;     #每个视频切片的时长。</span><br><span class="line">        hls_playlist_length 60s;  #总共可以回看的事件，这里设置的是1分钟。</span><br><span class="line">        #hls_continuous on; #连续模式。</span><br><span class="line">        #hls_cleanup on;    #对多余的切片进行删除。</span><br><span class="line">        #hls_nested on;     #嵌套模式。</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置http下rtmp_demo.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name rtmp.demo.app;</span><br><span class="line">    </span><br><span class="line">    location /stat &#123;</span><br><span class="line">        rtmp_stat all;</span><br><span class="line">        rtmp_stat_stylesheet stat.xsl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location /stat.xsl &#123;</span><br><span class="line">        root /usr/local/share/rtmp-nginx-module;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location /hls &#123;</span><br><span class="line">        types&#123;</span><br><span class="line">            application/vnd.apple.mpegurl m3u8;</span><br><span class="line">            video/mp2t ts;</span><br><span class="line">        &#125;</span><br><span class="line">        #alias /tmp/app;</span><br><span class="line">        root /Users/limx/Applications/runtime/rtmp;</span><br><span class="line">        expires -1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">        root /usr/local/share/rtmp-nginx-module/test/rtmp-publisher;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>直播测试 rtmp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg 模拟推流</span><br><span class="line">$ ffmpeg -re -i test.mp4 -f flv rtmp:127.0.0.1:13001/rtmp/test1</span><br><span class="line">mpv 模拟观看</span><br><span class="line">$ mpv rtmp://127.0.0.1:13001/rtmp/test1</span><br></pre></td></tr></table></figure>
</li>
<li><p>直播测试 hls</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg 模拟推流</span><br><span class="line">$ ffmpeg -re -i test.mp4 -f flv rtmp:127.0.0.1:13001/hls/test1</span><br><span class="line"></span><br><span class="line">H5</span><br><span class="line">&lt;video autoplay webkit-playsinline&gt;      </span><br><span class="line">    &lt;source src=&quot;http://rtmp.demo.app/hls/test1.m3u8&quot; type=&quot;application/vnd.apple.mpegurl&quot; /&gt;      </span><br><span class="line">    &lt;p class=&quot;warning&quot;&gt;Your browser does not support HTML5 video.&lt;/p&gt;   </span><br><span class="line">&lt;/video&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">crontab -e -u nginx</span><br><span class="line">00 05 * * * /usr/local/bin/php /www/web/monster-dks/run password:check@key &gt;&gt; /dev/null 2&gt;&amp;1</span><br><span class="line">*/10 * * * * /usr/local/bin/php /www/web/monster-dks/run password:check@key &gt;&gt; /dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2017/12/08/nginx/nginx/" data-id="cjitlmkrd0024rhntx8bgit8o" class="article-share-link">分享到</a><div class="tags"><a href="/tags/linux/">linux</a><a href="/tags/nginx/">nginx</a></div><div class="post-nav"><a href="/2017/12/08/linux/linux/" class="pre">linux 命令</a><a href="/2017/12/04/redis/install/" class="next">redis命令大全</a></div><div data-thread-key="2017/12/08/nginx/nginx/" data-title="nginx 配置" data-url="http://yoursite.com/2017/12/08/nginx/nginx/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2017/12/08/nginx/nginx/" data-title="nginx 配置" data-url="http://yoursite.com/2017/12/08/nginx/nginx/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><span class="category-list-count">18</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/laravel/">laravel</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/yii/">yii</a><span class="category-list-count">8</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/composer/">composer</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/node/">node</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/rsa/">rsa</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端之巅/">前端之巅</a><span class="category-list-count">28</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术杂谈/">技术杂谈</a><span class="category-list-count">11</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/linux/" style="font-size: 15px;">linux'</a> <a href="/tags/加密/" style="font-size: 15px;">加密</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/composer/" style="font-size: 15px;">composer</a> <a href="/tags/kong/" style="font-size: 15px;">kong</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/前端之巅/" style="font-size: 15px;">前端之巅</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/elasticsearch/" style="font-size: 15px;">elasticsearch</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/前端/" style="font-size: 15px;">前端</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/06/18/前端/async:await/">async/await</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/21/linux/kong/">kong安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/19/node/如何逃离async:await困境/">如何逃离async/await困境</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/13/mysql/mysql1/">MySQL数据库在物联网中的应用及其InnoDB的加锁分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/17/前端/React 组件转 Vue 组件/">React 组件转 Vue 组件</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/17/前端/webpack-gulp区别/">webpack-gulp</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/17/前端/px,em和rem的区别/">px,em和rem的区别</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/02/php/非Java语言注入Eureka/">非Java语言注入Eureka</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/18/前端/web/">web</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/13/php/PHP微服务/">基于Spring Cloud SideCar 构建异构PHP微服务</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">你总是这样轻言放弃的话，无论多久你都只会原地踏步。.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'xiaolinouye'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>